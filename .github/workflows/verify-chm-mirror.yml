name: Verify ChM Mirror

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  verify-mirror:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source repo (C-HASH-P)
      uses: actions/checkout@v3
      with:
        repository: 4RK-OFF/C-HASH-P
        path: source
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Checkout mirror repo (SIG3)
      uses: actions/checkout@v3
      with:
        repository: 4RK-OFF/universe.dao-sig3
        path: mirror
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Create hash_check.py (correct version)
      run: |
        mkdir -p source/verify
        cat <<EOF > source/verify/hash_check.py
        import hashlib, sys

        def extract_claimed_hash(lines):
            for line in lines:
                if line.startswith("ChM-HASH:"):
                    return line.strip().split(":", 1)[1].strip()
            return None

        def main(path):
            with open(path, "r") as f:
                lines = f.readlines()
                full_text = ''.join(lines)

            claimed = extract_claimed_hash(lines)
            if not claimed:
                print(f"{path}: ❌ No ChM-HASH found")
                return False

            # Hash the full file contents as-is
            computed = hashlib.sha256(full_text.encode("utf-8")).hexdigest()

            if claimed == computed:
                print(f"{path}: ✅ ChM-HASH matches")
                return True
            else:
                print(f"{path}: ❌ Hash mismatch")
                print(f"  Claimed:  {claimed}")
                print(f"  Computed: {computed}")
                return False

        if __name__ == "__main__":
            ok = main(sys.argv[1])
            sys.exit(0 if ok else 1)
        EOF

    - name: Compare ChM files, extract hashes, verify integrity
      run: |
        mkdir -p verify
        REPORT="verify/verify-report.txt"
        echo "🔍 C-HASH-P Mirror Report" > $REPORT
        echo "Generated: $(date -u)" >> $REPORT
        echo "" >> $REPORT

        for FILE in source/messages/ChM-[0-9]*.txt; do
          FILENAME=$(basename "$FILE")
          MIRROR_FILE="mirror/messages/$FILENAME"

          echo "▶ Checking $FILENAME" | tee -a $REPORT

          if [ ! -f "$MIRROR_FILE" ]; then
            echo "❌ $FILENAME missing in mirror!" | tee -a $REPORT
            echo "" >> $REPORT
            continue
          fi

          if ! diff -q "$FILE" "$MIRROR_FILE" > /dev/null; then
            echo "❌ $FILENAME mismatch between source and mirror!" | tee -a $REPORT
          else
            echo "✅ $FILENAME matches" | tee -a $REPORT
          fi

          HASH_LINE=$(grep '^ChM-HASH:' "$FILE" || echo "ChM-HASH: NOT FOUND")
          echo "$HASH_LINE" >> $REPORT
          echo "" >> $REPORT
        done

        echo "ChM-HASH Integrity Check" >> $REPORT
        echo "" >> $REPORT

        for FILE in source/messages/ChM-[0-9]*.txt; do
          echo "▶ $FILE" >> $REPORT
          python3 source/verify/hash_check.py "$FILE" >> $REPORT || true
          echo "" >> $REPORT
        done

