name: Verify ChM Mirror

on:
  workflow_dispatch:

jobs:
  verify-mirror:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source repo (C-HASH-P)
      uses: actions/checkout@v3
      with:
        repository: 4RK-OFF/C-HASH-P
        path: source

    - name: Checkout mirror repo (SIG3)
      uses: actions/checkout@v3
      with:
        repository: 4RK-OFF/universe.dao-sig3
        path: mirror

    - name: List files in both repos
      run: |
        echo "SOURCE:"
        ls -l source/messages/
        echo "MIRROR:"
        ls -l mirror/messages/

    - name: Compare ChM-2.txt files
      run: |
        echo "Comparing ChM-2.txt from both repos..."
        if ! diff -u source/messages/ChM-2.txt mirror/messages/ChM-2.txt; then
          echo "::error ::Mismatch found in ChM-2.txt between repos."
          echo "--- SOURCE:"
          cat source/messages/ChM-2.txt
          echo "--- MIRROR:"
          cat mirror/messages/ChM-2.txt
          exit 1
        fi
        echo "✅ ChM-2.txt files are identical."

    - name: Extract ChM-HASH and write to report
      run: |
        echo "🔍 Extracting ChM-HASH from ChM-2.txt..."

        HASH_LINE=$(grep '^ChM-HASH:' source/messages/ChM-2.txt || true)

        if [ -z "$HASH_LINE" ]; then
          echo "::error ::No ChM-HASH found in source/messages/ChM-2.txt"
          exit 1
        fi

        echo "File: ChM-2.txt" > verify-report.txt
        echo "$HASH_LINE" >> verify-report.txt

        echo "--- Verify Report ---"
        cat verify-report.txt
