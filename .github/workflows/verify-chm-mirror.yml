import hashlib
import sys

def extract_claimed_hash(path):
    with open(path, "r", encoding="utf-8") as f:
        for line in f:
            if line.startswith("ChM-HASH:"):
                return line.strip().split(":", 1)[1].strip()
    return None

def main(path):
    claimed = extract_claimed_hash(path)
    if not claimed:
        print(f"{path}: ❌ No ChM-HASH found")
        return False

    with open(path, "rb") as f:
        content = f.read()
    computed = hashlib.sha256(content).hexdigest()

    if claimed == computed:
        print(f"{path}: ✅ ChM-HASH matches")
        return True
    else:
        print(f"{path}: ❌ Hash mismatch")
        print(f"  Claimed:  {claimed}")
        print(f"  Computed: {computed}")
        return False

if __name__ == "__main__":
    sys.exit(0 if main(sys.argv[1]) else 1)
