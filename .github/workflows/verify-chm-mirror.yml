import hashlib
import sys

def extract_claimed_hash(lines):
    for line in lines:
        if line.startswith("ChM-HASH:"):
            return line.strip().split(":", 1)[1].strip()
    return None

def remove_chm_hash_line(lines):
    return [line for line in lines if not line.startswith("ChM-HASH:")]

def normalize_text(lines):
    # Normalize line endings and trim trailing whitespace
    return "\n".join([line.rstrip() for line in lines]).strip() + "\n"

def main(path):
    with open(path, "r") as f:
        lines = f.readlines()

    claimed = extract_claimed_hash(lines)
    if not claimed:
        print(f"{path}: ❌ No ChM-HASH found")
        return False

    content = normalize_text(remove_chm_hash_line(lines))
    computed = hashlib.sha256(content.encode("utf-8")).hexdigest()

    if claimed == computed:
        print(f"{path}: ✅ ChM-HASH matches")
        return True
    else:
        print(f"{path}: ❌ Hash mismatch")
        print(f"  Claimed:  {claimed}")
        print(f"  Computed: {computed}")
        return False

if __name__ == "__main__":
    ok = main(sys.argv[1])
    sys.exit(0 if ok else 1)
