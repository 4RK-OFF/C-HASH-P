name: Verify ChM Mirror

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  verify-mirror:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source repo (C-HASH-P)
      uses: actions/checkout@v3
      with:
        repository: 4RK-OFF/C-HASH-P
        path: source

    - name: Checkout mirror repo (SIG3)
      uses: actions/checkout@v3
      with:
        repository: 4RK-OFF/universe.dao-sig3
        path: mirror

    - name: Compare ChM files + generate report + SIG3
      run: |
        mkdir -p verify signers/SIG3
        REPORT="verify/verify-report.txt"
        echo "ðŸ” C-HASH-P Mirror Report" > $REPORT
        echo "Generated: $(date -u)" >> $REPORT
        echo "" >> $REPORT

        for FILE in source/messages/ChM-*.txt; do
          FILENAME=$(basename "$FILE")
          MIRROR_FILE="mirror/messages/$FILENAME"

          echo "â–¶ Checking $FILENAME" | tee -a $REPORT

          if [ ! -f "$MIRROR_FILE" ]; then
            echo "âŒ $FILENAME missing in mirror!" | tee -a $REPORT
            echo "" >> $REPORT
            continue
          fi

          if cmp -s "$FILE" "$MIRROR_FILE"; then
            echo "âœ… $FILENAME matches" | tee -a $REPORT
            HASH=$(sha256sum "$FILE" | awk '{print $1}')
            echo "ChM-HASH: $HASH" >> $REPORT

            # Write SIG3 if match
            echo "$HASH" > "source/signers/SIG3/SIG3-$FILENAME.sig"
          else
            echo "âŒ $FILENAME mismatch" | tee -a $REPORT
          fi
          echo "" >> $REPORT
        done

    - name: Copy report to UI folder
      run: cp source/verify/verify-report.txt source/ui/verify-report.txt

    - name: Commit and push report + SIG3
      run: |
        cd source
        git config --global user.name "chm-bot"
        git config --global user.email "chm@universe.dao"
        git add ui/verify-report.txt signers/SIG3/*.sig
        git commit -m "Update verify-report and SIG3 auto-signatures [auto]" || echo "No changes to commit"
        git push
