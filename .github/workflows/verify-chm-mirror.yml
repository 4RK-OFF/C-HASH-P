name: Verify ChM Mirror

on:
  workflow_dispatch:

jobs:
  verify-mirror:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source repo (C-HASH-P)
      uses: actions/checkout@v3
      with:
        repository: 4RK-OFF/C-HASH-P
        path: source
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Checkout mirror repo (SIG3)
      uses: actions/checkout@v3
      with:
        repository: 4RK-OFF/universe.dao-sig3
        path: mirror
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: List files in both repos
      run: |
        echo "SOURCE:"
        ls -l source/messages/
        echo "MIRROR:"
        ls -l mirror/messages/

    - name: Compare ChM-2.txt files
      run: |
        echo "Comparing ChM-2.txt from both repos..."
        if ! diff -u source/messages/ChM-2.txt mirror/messages/ChM-2.txt; then
          echo "::error ::Mismatch found in ChM-2.txt between repos."
          echo "--- SOURCE:"
          cat source/messages/ChM-2.txt
          echo "--- MIRROR:"
          cat mirror/messages/ChM-2.txt
          exit 1
        fi
        echo "✅ ChM-2.txt files are identical."

    - name: Extract ChM-HASH and write to report
      run: |
        echo "🔍 Extracting ChM-HASH from ChM-2.txt..."

        HASH_LINE=$(grep '^ChM-HASH:' source/messages/ChM-2.txt || true)

        if [ -z "$HASH_LINE" ]; then
          echo "::error ::No ChM-HASH found in source/messages/ChM-2.txt"
          exit 1
        fi

        mkdir -p verify
        echo "File: ChM-2.txt" > verify/verify-report.txt
        echo "$HASH_LINE" >> verify/verify-report.txt

        echo "--- Verify Report ---"
        cat verify/verify-report.txt

    - name: Commit and push verify report
      run: |
        cd source
        git config --global user.name "chm-verifier"
        git config --global user.email "chm-bot@users.noreply.github.com"
        cp ../verify/verify-report.txt verify/verify-report.txt
        git add verify/verify-report.txt
        git commit -m "Add ChM verify report [auto]" || echo "No changes to commit"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
