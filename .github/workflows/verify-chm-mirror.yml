name: Verify ChM Mirror

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  verify-mirror:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source repo (C-HASH-P)
      uses: actions/checkout@v3
      with:
        repository: 4RK-OFF/C-HASH-P
        path: source
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Checkout mirror repo (SIG3)
      uses: actions/checkout@v3
      with:
        repository: 4RK-OFF/universe.dao-sig3
        path: mirror
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Compare all ChM files and extract hashes
      run: |
        mkdir -p verify
        REPORT_FILE="verify/verify-report.txt"
        echo "🔍 C-HASH-P Mirror Report" > $REPORT_FILE
        echo "Generated: $(date -u)" >> $REPORT_FILE
        echo "" >> $REPORT_FILE

        for FILE in source/messages/ChM-*.txt; do
          FILENAME=$(basename "$FILE")
          MIRROR_FILE="mirror/messages/$FILENAME"

          echo "▶ Checking $FILENAME" | tee -a $REPORT_FILE

          if [ ! -f "$MIRROR_FILE" ]; then
            echo "❌ $FILENAME missing in mirror!" | tee -a $REPORT_FILE
            echo "" >> $REPORT_FILE
            continue
          fi

          if ! diff -q "$FILE" "$MIRROR_FILE" > /dev/null; then
            echo "❌ $FILENAME mismatch between source and mirror!" | tee -a $REPORT_FILE
          else
            echo "✅ $FILENAME matches" | tee -a $REPORT_FILE
          fi

          HASH_LINE=$(grep '^ChM-HASH:' "$FILE" || echo "ChM-HASH: NOT FOUND")
          echo "$HASH_LINE" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
        done

        echo "--- Verify Report ---"
        cat $REPORT_FILE

    - name: Commit and push verify report
      run: |
        cd source
        git config --global user.name "chm-verifier"
        git config --global user.email "chm-bot@users.noreply.github.com"
        cp ../verify/verify-report.txt verify/verify-report.txt
        git add verify/verify-report.txt
        git commit -m "Update verify report [auto]" || echo "No changes to commit"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/4RK-OFF/C-HASH-P.git
        git push origin HEAD
