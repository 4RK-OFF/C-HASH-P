name: Create Canonical Message from CM Draft

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-canonical-message:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Create ChM-x.txt from CM-x.txt with canonical header
      run: |
        mkdir -p messages
        cd messages

        for CM_FILE in CM-*.txt; do
          if [ ! -f "$CM_FILE" ]; then
            echo "❌ No CM-*.txt files found."
            exit 1
          fi

          echo "▶ Processing $CM_FILE"

          # Extract footer line with ChM-ID and C-HASH
          FOOTER_LINE=$(grep '^ChM-' "$CM_FILE")

          if [[ -z "$FOOTER_LINE" ]]; then
            echo "❌ Missing ChM footer line in $CM_FILE"
            continue
          fi

          CHM_ID=$(echo "$FOOTER_LINE" | cut -d':' -f1)     # ChM-42
          VERSION=$(echo "$FOOTER_LINE" | cut -d':' -f2)     # v1
          C_HASH=$(echo "$FOOTER_LINE" | cut -d':' -f3)      # actual hash

          CHM_FILE="$CHM_ID.txt"

          # Compute SHA256 hash of full content
          CHM_HASH=$(sha256sum "$CM_FILE" | awk '{print $1}')

          # Current UTC timestamp
          UTC=$(date -u +"%Y-%m-%d %H:%M UTC")

          # Write canonical output file
          {
            echo "ID: $CHM_ID"
            echo "UTC: $UTC"
            echo "ChM-HASH: $CHM_HASH"
            echo "C-HASH: $C_HASH"
            echo ""
            echo "Message:"
            cat "$CM_FILE"
          } > "$CHM_FILE"

          echo "✅ Generated $CHM_FILE"
        done

    - name: Commit and push new ChM files
      run: |
        git config --global user.name "chm-bot"
        git config --global user.email "chm@universe.dao"
        git add messages/ChM-*.txt
        git commit -m "Generate ChM from CM [auto]" || echo "No changes to commit"
        git push
